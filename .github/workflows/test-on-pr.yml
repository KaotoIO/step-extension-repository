name: Run tests

on:
  pull_request:
  workflow_dispatch:

jobs:
  folders:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
    - name: ğŸ¡  Set Matrix
      id: set-matrix
      run: |
          files=$(find . -maxdepth 1 -mindepth 1 -not -name '.*' -type d -printf '"%P",' );
          echo "matrix=["${files%?}"]" >> $GITHUB_OUTPUT
  run-tests:
    needs: folders
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        folder: ${{ fromJson(needs.folders.outputs.matrix) }}
      fail-fast: false
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
    - name: ğŸ§® Run tests
      run: cd ${{ matrix.folder }}; yarn install; yarn test

  # Attempt to build
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      - name: ğŸ”§ Build extensions
        run: ./build.sh
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: 'dist'
